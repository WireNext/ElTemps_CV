<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Temps al teu poble</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" href="multimedia/logo.png">
</head>
<body>
  <header>
    <h1>El Temps al teu poble</h1>
  </header>

  <nav>
    <a href="index.html">ğŸ  Inici</a>
    <a href="avisos.html">âš ï¸ Avisos</a>
    <a href="emergencies.html">ğŸš¨ EmergÃ¨ncies</a>
    <a href="radar.html">ğŸŒ§ï¸ Radar</a>
    <a href="transit.html">ğŸš— TrÃ nsit</a>
    <a href="buscador.html" class="active">ğŸ” El teu poble</a>
    <button id="theme-toggle" aria-label="Canvia el mode">ğŸŒ“ Mode</button>
  </nav>

  <main class="container" style="display: block; text-align: center;">
    <h2>Consulta el temps al teu municipi</h2>

    <div id="buscador-container">
      <input 
        type="text" 
        id="buscador" 
        placeholder="Escriu el teu poble..." 
        list="municipios" 
      >
      <datalist id="municipios"></datalist>
      <button onclick="buscarTiempo()">Cercar</button>
    </div>

    <div id="resultado-tiempo"></div>
  </main>

  <footer>
    <p>Â© 2025 Meteorologia Comunitat Valenciana â€” Desenvolupat per WireNext</p>
  </footer>

  <script>
  // Mapeo simple de cÃ³digos de tiempo de Open-Meteo a emojis
  function obtenerIcono(code) {
    if (code >= 0 && code <= 1) return "â˜€ï¸"; // Despejado o casi
    if (code >= 2 && code <= 3) return "ğŸŒ¤ï¸"; // Parcialmente nublado
    if (code >= 45 && code <= 48) return "ğŸŒ«ï¸"; // Niebla
    if ((code >= 51 && code <= 55) || (code >= 61 && code <= 65) || (code >= 80 && code <= 82)) return "ğŸŒ§ï¸"; // Lluvia/Chubascos
    if ((code >= 71 && code <= 75) || (code >= 85 && code <= 86)) return "â„ï¸"; // Nieve
    if (code >= 95 && code <= 99) return "ğŸŒ©ï¸"; // Tormenta
    return "â“"; // Desconocido
  }

  // Carrega els municipis des del fitxer JSON
  async function carregarMunicipis() {
    try {
      const resposta = await fetch("municipis.json");
      const dades = await resposta.json();
      const datalist = document.getElementById("municipios");

      dades.municipis.forEach(m => {
        const option = document.createElement("option");
        option.value = m;
        datalist.appendChild(option);
      });
    } catch (e) {
      console.error("No s'ha pogut carregar la llista de municipis:", e);
    }
  }

 // Busca el temps en el municipi indicat
  async function buscarTiempo() {
    const poble = document.getElementById("buscador").value.trim();
    const resultat = document.getElementById("resultado-tiempo");

    if (!poble) {
      resultat.innerHTML = "<p>âš ï¸ Escriu un municipi per continuar.</p>";
      return;
    }

    resultat.innerHTML = "â³ Cercant dades meteorolÃ²giques...";

    try {
      // 1ï¸âƒ£ Buscar coordenades (BÃºsqueda mÃ¡s flexible, sin aÃ±adir "Comunitat Valenciana")
      // Usamos language=es para mejorar la tasa de acierto en nombres de ciudades principales
      const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(poble)}&count=1&language=es`);
      const geoData = await geoRes.json();

      // VERIFICACIÃ“N CLAVE: Comprobar si hay resultados
      if (!geoData.results || geoData.results.length === 0) {
        // FallÃ³ la bÃºsqueda geogrÃ¡fica
        resultat.innerHTML = "âŒ No s'ha trobat el municipi. Intenta amb el nom oficial en castellÃ  (ex: 'Alicante' en lloc de 'Alacant').";
        return;
      }

      // Filtrar para intentar forzar que sea de EspaÃ±a (cÃ³digo ğŸ‡ªğŸ‡¸ = 275)
      const resultatsEspanya = geoData.results.filter(r => r.country_code === 'ES' || r.country === 'Spain');
      
      let millorResultat;
      if (resultatsEspanya.length > 0) {
          // Si hi ha resultats d'Espanya, agafem el primer
          millorResultat = resultatsEspanya[0];
      } else {
          // Si no hi ha resultats d'Espanya (o nomÃ©s hi ha un sense codi de paÃ­s), agafem el primer
          millorResultat = geoData.results[0];
      }
      
      const { latitude, longitude, name, country } = millorResultat;

      // 2ï¸âƒ£ Consultar Open-Meteo
      const meteoRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&timezone=auto`);
      const meteoData = await meteoRes.json();
      
      // ... (El resto de la funciÃ³n es igual para mostrar el resultado)
      const weather = meteoData.current_weather;
      const icono = obtenerIcono(weather.weathercode);

      // 3ï¸âƒ£ Mostrar resultat amb format visual
      resultat.innerHTML = `
        <h3>${name} (${country})</h3>
        <span class="weather-icon">${icono}</span>
        <span class="temperature">${weather.temperature} Â°C</span>
        <div class="details">
          <p>ğŸ’¨ Vent: <strong>${weather.windspeed} km/h</strong></p>
          <p>ğŸŒ¬ï¸ DirecciÃ³: ${weather.winddirection}Â°</p>
          <p>ğŸ•’ ObservaciÃ³: ${new Date(weather.time).toLocaleTimeString("ca-ES")}</p>
        </div>
      `;
    } catch (error) {
      console.error(error);
      resultat.innerHTML = "âš ï¸ Error en obtenir les dades meteorolÃ²giques.";
    }
  }

  // Carregar municipis en iniciar la pÃ gina
  carregarMunicipis();
  </script>

  <script src="js/script.js"></script>
</body>
</html>
