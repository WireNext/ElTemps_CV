<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Temps al teu poble</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" href="multimedia/logo.png">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8789822435662410"
     crossorigin="anonymous"></script>
</head>
<body>
  <header>
    <h1>El Temps al teu poble</h1>
  </header>

  <nav>
    <a href="index.html">ğŸ  Inici</a>
    <a href="avisos.html">âš ï¸ Avisos</a>
    <a href="emergencies.html">ğŸš¨ EmergÃ¨ncies</a>
    <a href="radar.html">ğŸŒ§ï¸ Radar</a>
    <a href="transit.html">ğŸš— TrÃ nsit</a>
    <a href="buscador.html">ğŸ” El teu poble</a>
    <button id="theme-toggle" aria-label="Canvia el mode">ğŸŒ“ Mode</button>
  </nav>

  <main class="container" style="display: block; text-align: center;">
    <h2>Consulta el temps al teu municipi</h2>

    <div id="buscador-container">
      <input 
        type="text" 
        id="buscador" 
        placeholder="Escriu el teu poble..." 
        list="municipios" 
      >
      <datalist id="municipios"></datalist>
      <button onclick="buscarTiempo()">Cercar</button>
    </div>

    <div id="resultado-tiempo"></div>
  </main>

  <footer>
    <p>Â© 2025 Meteorologia Comunitat Valenciana â€” Desenvolupat per WireNext</p>
  </footer>

  <script>
  // Escolta la tecla Enter en l'input per a major comoditat
  document.getElementById("buscador").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      buscarTiempo();
    }
  });

  function obtenerIcono(code) {
    if (code >= 0 && code <= 1) return "â˜€ï¸"; 
    if (code >= 2 && code <= 3) return "ğŸŒ¤ï¸"; 
    if (code >= 45 && code <= 48) return "ğŸŒ«ï¸"; 
    if ((code >= 51 && code <= 55) || (code >= 61 && code <= 65) || (code >= 80 && code <= 82)) return "ğŸŒ§ï¸"; 
    if ((code >= 71 && code <= 75) || (code >= 85 && code <= 86)) return "â„ï¸"; 
    if (code >= 95 && code <= 99) return "ğŸŒ©ï¸"; 
    return "â“"; 
  }

  function obtenerDiaSemana(dateString) {
    const date = new Date(dateString);
    const avui = new Date();
    if (date.toDateString() === avui.toDateString()) return "Avui";
    const options = { weekday: 'short', day: 'numeric' };
    return date.toLocaleDateString("ca-ES", options);
  }

  async function carregarMunicipis() {
    try {
      const resposta = await fetch("municipis.json");
      const dades = await resposta.json();
      const datalist = document.getElementById("municipios");
      dades.municipis.forEach(m => {
        const option = document.createElement("option");
        option.value = m;
        datalist.appendChild(option);
      });
    } catch (e) {
      console.error("No s'ha pogut carregar la llista de municipis:", e);
    }
  }

  async function buscarTiempo() {
    const poble = document.getElementById("buscador").value.trim();
    const resultat = document.getElementById("resultado-tiempo");

    if (!poble) {
      resultat.innerHTML = "<p>âš ï¸ Escriu un municipi per continuar.</p>";
      return;
    }

    resultat.innerHTML = "â³ Cercant dades meteorolÃ²giques...";

    try {
      // Millora: BÃºsqueda flexible centrada en Espanya per evitar resultats internacionals
      const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(poble)}&count=5&language=ca`);
      const geoData = await geoRes.json();

      if (!geoData.results || geoData.results.length === 0) {
        resultat.innerHTML = "âŒ No s'ha trobat el municipi.";
        return;
      }

      // Prioritzem el primer resultat que siga d'Espanya
      const m = geoData.results.find(r => r.country_code === 'ES') || geoData.results[0];
      consultarMeteo(m.latitude, m.longitude, m.name);

    } catch (error) {
      resultat.innerHTML = "âš ï¸ Error en la cerca.";
    }
  }

  async function consultarMeteo(lat, lon, nombre) {
    const resultat = document.getElementById("resultado-tiempo");
    try {
      // ObtenciÃ³ de dades detallades: sensaciÃ³, humitat, Ã­ndex UV i pluja
      const meteoUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,uv_index_max&timezone=auto`;
      const meteoRes = await fetch(meteoUrl);
      const meteoData = await meteoRes.json();

      const current = meteoData.current;
      const daily = meteoData.daily;

      let htmlResultat = `<h3>${nombre}</h3>`;
      
      // Temps Actual amb dades arrodonides
      htmlResultat += `
        <h4>Temps Actual</h4>
        <div id="temps-actual-card">
            <span class="weather-icon">${obtenerIcono(current.weather_code)}</span>
            <span class="temperature">${Math.round(current.temperature_2m)} Â°C</span>
            <div class="details">
                <p>ğŸŒ¡ï¸ SensaciÃ³: <strong>${Math.round(current.apparent_temperature)} Â°C</strong></p>
                <p>ğŸ’§ Humitat: <strong>${current.relative_humidity_2m}%</strong></p>
                <p>â˜€ï¸ Ãndex UV: <strong>${Math.round(daily.uv_index_max[0])}</strong></p>
                <p>ğŸ’¨ Vent: <strong>${Math.round(current.wind_speed_10m)} km/h</strong></p>
            </div>
        </div>
      `;

      htmlResultat += `
        <h4>PrevisiÃ³ 7 Dies</h4>
        <div id="previsio-7dies-container">
      `;

      for (let i = 0; i < 7; i++) {
        const dia = obtenerDiaSemana(daily.time[i]);
        const iconoDia = obtenerIcono(daily.weather_code[i]);
        const probPluja = daily.precipitation_probability_max[i];
        
        htmlResultat += `
          <div class="previsio-dia">
            <p class="dia-setmana">${dia}</p>
            <span class="previsio-icon">${iconoDia}</span>
            <p class="temp-range">
              <span class="max-temp">${Math.round(daily.temperature_2m_max[i])}Â°</span> <br> 
              <span class="min-temp">${Math.round(daily.temperature_2m_min[i])}Â°</span>
            </p>
            <p style="font-size: 0.75rem; margin-top: 5px; color: var(--accent);">ğŸ’§ ${probPluja}%</p>
          </div>
        `;
      }

      htmlResultat += `</div>`; 
      resultat.innerHTML = htmlResultat;

    } catch (e) {
      resultat.innerHTML = "âš ï¸ Error en carregar el temps.";
    }
  }

  carregarMunicipis();
  </script>

  <script src="js/script.js"></script>
</body>
</html>