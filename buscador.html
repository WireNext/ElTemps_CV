<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>El Temps al teu poble</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" href="multimedia/logo.png">
</head>
<body>
  <header>
    <h1>El Temps al teu poble</h1>
  </header>

  <nav>
    <a href="index.html">ğŸ  Inici</a>
    <a href="avisos.html">âš ï¸ Avisos</a>
    <a href="emergencies.html">ğŸš¨ EmergÃ¨ncies</a>
    <a href="radar.html">ğŸŒ§ï¸ Radar</a>
    <a href="transit.html">ğŸš— TrÃ nsit</a>
    <a href="buscador.html">ğŸ” El teu poble</a>
    <button id="theme-toggle" aria-label="Canvia el mode">ğŸŒ“ Mode</button>
  </nav>

  <main class="container" style="display: block; text-align: center;">
    <h2>Consulta el temps al teu municipi</h2>

    <div id="buscador-container">
      <input 
        type="text" 
        id="buscador" 
        placeholder="Escriu el teu poble..." 
        list="municipios" 
      >
      <datalist id="municipios"></datalist>
      <button onclick="buscarTiempo()">Cercar</button>
    </div>

    <div id="resultado-tiempo"></div>
  </main>

  <footer>
    <p>Â© 2025 Meteorologia Comunitat Valenciana â€” Desenvolupat per WireNext</p>
  </footer>

  <script>
  // Mapeo simple de cÃ³digos de tiempo de Open-Meteo a emojis
  function obtenerIcono(code) {
    if (code >= 0 && code <= 1) return "â˜€ï¸"; // Despejado o casi
    if (code >= 2 && code <= 3) return "ğŸŒ¤ï¸"; // Parcialmente nublado
    if (code >= 45 && code <= 48) return "ğŸŒ«ï¸"; // Niebla
    if ((code >= 51 && code <= 55) || (code >= 61 && code <= 65) || (code >= 80 && code <= 82)) return "ğŸŒ§ï¸"; // Lluvia/Chubascos
    if ((code >= 71 && code <= 75) || (code >= 85 && code <= 86)) return "â„ï¸"; // Nieve
    if (code >= 95 && code <= 99) return "ğŸŒ©ï¸"; // Tormenta
    return "â“"; // Desconocido
  }

  // Genera el nombre del dÃ­a de la semana
  function obtenerDiaSemana(dateString) {
    // Para el dÃ­a actual, mostraremos 'Avui', si no, el nombre corto.
    const date = new Date(dateString);
    const avui = new Date();
    
    // Si la fecha coincide con el dÃ­a de hoy, retornamos 'Avui' (Hoy)
    if (date.toDateString() === avui.toDateString()) {
        return "Avui";
    }
    
    // Si no es hoy, retornamos el nombre corto (Lun, Mar, etc.)
    const options = { weekday: 'short', day: 'numeric' };
    return date.toLocaleDateString("ca-ES", options);
  }

  // Carrega els municipis (mantener esta funciÃ³n intacta)
  async function carregarMunicipis() {
    try {
      const resposta = await fetch("municipis.json");
      const dades = await resposta.json();
      const datalist = document.getElementById("municipios");

      dades.municipis.forEach(m => {
        const option = document.createElement("option");
        option.value = m;
        datalist.appendChild(option);
      });
    } catch (e) {
      console.error("No s'ha pogut carregar la llista de municipis:", e);
    }
  }

  // Busca el temps i la previsiÃ³
  async function buscarTiempo() {
    const poble = document.getElementById("buscador").value.trim();
    const resultat = document.getElementById("resultado-tiempo");

    if (!poble) {
      resultat.innerHTML = "<p>âš ï¸ Escriu un municipi per continuar.</p>";
      return;
    }

    resultat.innerHTML = "â³ Cercant dades meteorolÃ²giques...";

    try {
      // 1ï¸âƒ£ Buscar coordenades (BÃºsqueda flexible)
      const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(poble)}&count=1&language=es`);
      const geoData = await geoRes.json();

      if (!geoData.results || geoData.results.length === 0) {
        resultat.innerHTML = "âŒ No s'ha trobat el municipi. Intenta amb el nom oficial en castellÃ .";
        return;
      }

      const resultatsEspanya = geoData.results.filter(r => r.country_code === 'ES' || r.country === 'Spain');
      const millorResultat = resultatsEspanya.length > 0 ? resultatsEspanya[0] : geoData.results[0];
      
      const { latitude, longitude, name, country } = millorResultat;

      // 2ï¸âƒ£ Consultar Open-Meteo per a la previsiÃ³ de 7 dies i temps actual
      // Se aÃ±aden los parÃ¡metros 'daily' para obtener la previsiÃ³n
      const meteoUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&timezone=auto&daily=weathercode,temperature_2m_max,temperature_2m_min,windspeed_10m_max,winddirection_10m_dominant`;
      const meteoRes = await fetch(meteoUrl);
      const meteoData = await meteoRes.json();

      const current = meteoData.current_weather;
      const daily = meteoData.daily;
      const currentIcono = obtenerIcono(current.weathercode);

      // Iniciar el HTML del resultado
      let htmlResultat = `<h3>${name} (${country})</h3>`;
      
      // --- BLOQUE 1: Temps Actual (amb Max/Min del dia) ---
      htmlResultat += `
        <h4>Temps Actual</h4>
        <div id="temps-actual-card">
            <span class="weather-icon">${currentIcono}</span>
            <span class="temperature">${current.temperature} Â°C</span>
            <div class="details">
                <p><strong>${daily.temperature_2m_min[0]} Â°C /</strong> <strong>${daily.temperature_2m_max[0]} Â°C</strong></p>
                <p>ğŸ’¨ Vent: ${current.windspeed} km/h</p>
                <p>ğŸ•’ ObservaciÃ³: ${new Date(current.time).toLocaleTimeString("ca-ES")}</p>
            </div>
        </div>
      `;

      // --- BLOQUE 2: PrevisiÃ³ 7 Dies ---
      htmlResultat += `
        <h4>PrevisiÃ³ 7 Dies</h4>
        <div id="previsio-7dies-container">
      `;

      // Recorrer los 7 dÃ­as (0 a 6)
      for (let i = 0; i < 7; i++) {
        const dia = obtenerDiaSemana(daily.time[i]);
        const maxTemp = daily.temperature_2m_max[i];
        const minTemp = daily.temperature_2m_min[i];
        const iconoDia = obtenerIcono(daily.weathercode[i]);
        
        htmlResultat += `
          <div class="previsio-dia">
            <p class="dia-setmana">${dia}</p>
            <span class="previsio-icon">${iconoDia}</span>
            <p class="temp-range">
              <span class="max-temp">${maxTemp}Â°</span> <br> <span class="min-temp">${minTemp}Â°</span>
            </p>
          </div>
        `;
      }

      htmlResultat += `</div>`; // Tancar #previsio-7dies-container
      resultat.innerHTML = htmlResultat;

    } catch (error) {
      console.error(error);
      resultat.innerHTML = "âš ï¸ Error en obtenir les dades meteorolÃ²giques.";
    }
  }

  // Carregar municipis en iniciar la pÃ gina
  carregarMunicipis();
  </script>

  <script src="js/script.js"></script>
</body>
</html>
